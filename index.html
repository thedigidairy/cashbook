<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cash Book</title>
  <style>
    :root {
      --bg: #f2f2f2;
      --card: #ffffff;
      --text: #222222;
      --muted: #555555;
      --border: #d9d9d9;
      --accent: #2b6cb0;
      --income: #2f855a;
      --expense: #c53030;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
      font-size: 18px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      text-align: center;
      margin-bottom: 16px;
      font-size: 32px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      align-items: end;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 16px;
    }

    input,
    select,
    button {
      width: 100%;
      padding: 10px 12px;
      font-size: 18px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    input:focus,
    select:focus,
    button:focus {
      outline: 3px solid rgba(43, 108, 176, 0.2);
      outline-offset: 1px;
    }

    button {
      background: var(--accent);
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background: #245c98;
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      font-weight: bold;
      font-size: 20px;
    }

    .totals span {
      display: block;
      font-size: 16px;
      font-weight: normal;
      color: var(--muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 16px;
    }

    th,
    td {
      border: 1px solid var(--border);
      padding: 10px;
      text-align: left;
    }

    th {
      background: #f8f8f8;
      font-size: 17px;
    }

    .amount-income {
      color: var(--income);
      font-weight: bold;
    }

    .amount-expense {
      color: var(--expense);
      font-weight: bold;
    }

    .balance-positive {
      color: var(--income);
      font-weight: bold;
    }

    .balance-negative {
      color: var(--expense);
      font-weight: bold;
    }

    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 12px;
    }

    .voice-button {
      padding: 8px 10px;
      font-size: 16px;
    }

    @keyframes voiceGlow {
      0% {
        box-shadow: 0 0 0 0 rgba(43, 108, 176, 0.1);
        border-color: var(--border);
      }

      50% {
        box-shadow: 0 0 0 4px rgba(43, 108, 176, 0.25);
        border-color: var(--accent);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(43, 108, 176, 0.1);
        border-color: var(--border);
      }
    }

    .voice-highlight {
      animation: voiceGlow 0.5s ease-in-out 3;
    }

    @media (max-width: 600px) {
      body {
        font-size: 16px;
      }

      h1 {
        font-size: 26px;
      }

      .totals {
        font-size: 18px;
      }

      table {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cash Book</h1>

    <div class="card">
      <form id="entry-form" class="form-grid">
        <div>
          <label for="language-select">Language</label>
          <select id="language-select" aria-label="Language selection">
            <option value="en">English</option>
            <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
            <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
          </select>
        </div>
        <div>
          <label for="entry-date" id="label-date">Date</label>
          <input type="date" id="entry-date" required />
        </div>
        <div>
          <label for="entry-desc" id="label-desc">Description / Note</label>
          <input type="text" id="entry-desc" placeholder="e.g., Groceries" required />
        </div>
        <div>
          <label for="entry-amount" id="label-amount">Amount</label>
          <input type="number" id="entry-amount" min="0" step="0.01" placeholder="0.00" required />
        </div>
        <div>
          <label for="entry-type" id="label-type">Type</label>
          <select id="entry-type" required>
            <option value="income" id="type-income-option">Income</option>
            <option value="expense" id="type-expense-option">Expense</option>
          </select>
        </div>
        <div>
          <button type="submit" id="submit-button">Save Entry</button>
        </div>
        <div>
          <button type="button" id="voice-input-button" class="voice-button">üé§ Voice Input</button>
        </div>
      </form>
    </div>

    <div class="card totals" id="totals">
      <div>
        <span id="label-total-income-text">Total Income</span> (‚Çπ)
        <span id="total-income">‚Çπ0</span>
      </div>
      <div>
        <span id="label-total-expense-text">Total Expense</span> (‚Çπ)
        <span id="total-expense">‚Çπ0</span>
      </div>
      <div>
        <span id="label-current-balance-text">Current Balance</span> (‚Çπ)
        <span id="current-balance">‚Çπ0</span>
      </div>
    </div>

    <div class="card">
      <table aria-label="Cash book entries">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Income (‚Çπ)</th>
            <th>Expense (‚Çπ)</th>
            <th>Running Balance (‚Çπ)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="entries-body"></tbody>
      </table>
      <div id="empty-state" class="empty-state">No entries yet. Add your first entry above.</div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "cashbookEntries";
    const form = document.getElementById("entry-form");
    const dateInput = document.getElementById("entry-date");
    const descInput = document.getElementById("entry-desc");
    const amountInput = document.getElementById("entry-amount");
    const typeInput = document.getElementById("entry-type");
    const entriesBody = document.getElementById("entries-body");
    const emptyState = document.getElementById("empty-state");
    const submitButton = document.getElementById("submit-button");
    const totalIncomeEl = document.getElementById("total-income");
    const totalExpenseEl = document.getElementById("total-expense");
    const currentBalanceEl = document.getElementById("current-balance");
    const voiceInputButton = document.getElementById("voice-input-button");
    const languageSelect = document.getElementById("language-select");
    const labelDate = document.getElementById("label-date");
    const labelDesc = document.getElementById("label-desc");
    const labelAmount = document.getElementById("label-amount");
    const labelType = document.getElementById("label-type");
    const typeIncomeOption = document.getElementById("type-income-option");
    const typeExpenseOption = document.getElementById("type-expense-option");
    const labelTotalIncomeText = document.getElementById("label-total-income-text");
    const labelTotalExpenseText = document.getElementById("label-total-expense-text");
    const labelCurrentBalanceText = document.getElementById("label-current-balance-text");
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let editIndex = null;
    let recognition = null;
    let currentLanguage = "en";

    const languageConfig = {
      en: {
        ui: {
          date: "Date",
          description: "Description / Note",
          amount: "Amount",
          type: "Type",
          income: "Income",
          expense: "Expense",
          saveEntry: "Save Entry",
          totalIncome: "Total Income",
          totalExpense: "Total Expense",
          currentBalance: "Current Balance",
          voiceInput: "üé§ Voice Input",
          descPlaceholder: "e.g., Groceries",
          unsupportedSpeech: "Voice input is not supported in this browser. Please enter details manually.",
          missingFields: "Please fill out date, description, and amount.",
          invalidAmount: "Please enter a valid amount greater than zero.",
        },
        speechLang: "en-IN",
        keywords: {
          date: ["date"],
          description: ["description", "note"],
          amount: ["amount"],
          income: ["income"],
          expense: ["expense"],
        },
      },
      te: {
        ui: {
          date: "‡∞§‡±á‡∞¶‡±Ä",
          description: "‡∞µ‡∞ø‡∞µ‡∞∞‡∞£ / ‡∞ó‡∞Æ‡∞®‡∞ø‡∞ï",
          amount: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç",
          type: "‡∞∞‡∞ï‡∞Ç",
          income: "‡∞Ü‡∞¶‡∞æ‡∞Ø‡∞Ç",
          expense: "‡∞ñ‡∞∞‡±ç‡∞ö‡±Å",
          saveEntry: "‡∞∏‡±á‡∞µ‡±ç ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä",
          totalIncome: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞Ü‡∞¶‡∞æ‡∞Ø‡∞Ç",
          totalExpense: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞ñ‡∞∞‡±ç‡∞ö‡±Å",
          currentBalance: "‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞®‡∞ø‡∞≤‡±ç‡∞µ",
          voiceInput: "üé§ ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞á‡∞®‡±ç‡∞™‡±Å‡∞ü‡±ç",
          descPlaceholder: "‡∞â‡∞¶‡∞æ., ‡∞ï‡∞ø‡∞∞‡∞æ‡∞£‡∞æ",
          unsupportedSpeech: "‡∞à ‡∞¨‡±ç‡∞∞‡±å‡∞ú‡∞∞‡±ç‚Äå‡∞≤‡±ã ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞á‡∞®‡±ç‡∞™‡±Å‡∞ü‡±ç‚Äå‡∞ï‡±Å ‡∞Æ‡∞¶‡±ç‡∞¶‡∞§‡±Å ‡∞≤‡±á‡∞¶‡±Å. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡∞®‡±Å ‡∞Æ‡∞æ‡∞®‡±ç‡∞Ø‡±Å‡∞µ‡∞≤‡±ç‚Äå‡∞ó‡∞æ ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.",
          missingFields: "‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞§‡±á‡∞¶‡±Ä, ‡∞µ‡∞ø‡∞µ‡∞∞‡∞£ ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.",
          invalidAmount: "‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞∏‡±Å‡∞®‡±ç‡∞®‡∞æ ‡∞ï‡∞Ç‡∞ü‡±á ‡∞é‡∞ï‡±ç‡∞ï‡±Å‡∞µ ‡∞ö‡±Ü‡∞≤‡±ç‡∞≤‡±Å‡∞¨‡∞æ‡∞ü‡±Å ‡∞Ö‡∞Ø‡±ç‡∞Ø‡±á ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.",
        },
        speechLang: "te-IN",
        keywords: {
          date: ["‡∞§‡±á‡∞¶‡±Ä", "‡∞°‡±á‡∞ü‡±ç"],
          description: ["‡∞µ‡∞ø‡∞µ‡∞∞‡∞£", "‡∞ó‡∞Æ‡∞®‡∞ø‡∞ï"],
          amount: ["‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç", "‡∞Ö‡∞Æ‡±å‡∞Ç‡∞ü‡±ç"],
          income: ["‡∞Ü‡∞¶‡∞æ‡∞Ø‡∞Ç", "‡∞á‡∞Ç‡∞ï‡∞Æ‡±ç"],
          expense: ["‡∞ñ‡∞∞‡±ç‡∞ö‡±Å", "‡∞é‡∞ï‡±ç‡∞∏‡±ç‚Äå‡∞™‡±Ü‡∞®‡±ç‡∞∏‡±ç"],
        },
      },
      hi: {
        ui: {
          date: "‡§§‡§æ‡§∞‡•Ä‡§ñ",
          description: "‡§µ‡§ø‡§µ‡§∞‡§£ / ‡§®‡•ã‡§ü",
          amount: "‡§∞‡§æ‡§∂‡§ø",
          type: "‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
          income: "‡§Ü‡§Ø",
          expense: "‡§ñ‡§∞‡•ç‡§ö",
          saveEntry: "‡§∏‡•á‡§µ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä",
          totalIncome: "‡§ï‡•Å‡§≤ ‡§Ü‡§Ø",
          totalExpense: "‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö",
          currentBalance: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∂‡•á‡§∑",
          voiceInput: "üé§ ‡§µ‡•â‡§á‡§∏ ‡§á‡§®‡§™‡•Å‡§ü",
          descPlaceholder: "‡§â‡§¶‡§æ., ‡§ï‡§ø‡§∞‡§æ‡§®‡§æ",
          unsupportedSpeech: "‡§á‡§∏ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§µ‡•â‡§á‡§∏ ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§",
          missingFields: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ, ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§î‡§∞ ‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç‡•§",
          invalidAmount: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∞‡§æ‡§∂‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§",
        },
        speechLang: "hi-IN",
        keywords: {
          date: ["‡§§‡§æ‡§∞‡•Ä‡§ñ", "‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï", "‡§°‡•á‡§ü"],
          description: ["‡§µ‡§ø‡§µ‡§∞‡§£", "‡§®‡•ã‡§ü"],
          amount: ["‡§∞‡§æ‡§∂‡§ø", "‡§Ö‡§Æ‡§æ‡§â‡§Ç‡§ü"],
          income: ["‡§Ü‡§Ø", "‡§á‡§®‡§ï‡§Æ"],
          expense: ["‡§ñ‡§∞‡•ç‡§ö", "‡§µ‡•ç‡§Ø‡§Ø", "‡§è‡§ï‡•ç‡§∏‡§™‡•á‡§Ç‡§∏"],
        },
      },
    };

    const moneyFormat = new Intl.NumberFormat("en-IN", {
      style: "currency",
      currency: "INR",
      minimumFractionDigits: 0,
      maximumFractionDigits: 2,
    });

    function getUiText(key) {
      return languageConfig[currentLanguage].ui[key] || languageConfig.en.ui[key] || "";
    }

    function setLanguage(languageCode) {
      if (!languageConfig[languageCode]) {
        languageCode = "en";
      }
      currentLanguage = languageCode;
      languageSelect.value = languageCode;

      labelDate.textContent = getUiText("date");
      labelDesc.textContent = getUiText("description");
      labelAmount.textContent = getUiText("amount");
      labelType.textContent = getUiText("type");
      typeIncomeOption.textContent = getUiText("income");
      typeExpenseOption.textContent = getUiText("expense");
      submitButton.textContent = getUiText("saveEntry");
      voiceInputButton.textContent = getUiText("voiceInput");
      labelTotalIncomeText.textContent = getUiText("totalIncome");
      labelTotalExpenseText.textContent = getUiText("totalExpense");
      labelCurrentBalanceText.textContent = getUiText("currentBalance");
      descInput.placeholder = getUiText("descPlaceholder");

      if (recognition) {
        recognition.lang = languageConfig[currentLanguage].speechLang;
      }
    }

    function formatDateForDisplay(isoDate) {
      if (!isoDate || typeof isoDate !== "string") {
        return "";
      }
      const [year, month, day] = isoDate.split("-");
      if (!year || !month || !day) {
        return isoDate;
      }
      return `${day}-${month}-${year}`;
    }

    function parseAmountToPaise(amountValue) {
      if (typeof amountValue !== "string") {
        return null;
      }
      const trimmed = amountValue.trim();
      if (!trimmed) {
        return null;
      }
      const match = /^\d+(?:\.(\d{0,2}))?$/.exec(trimmed);
      if (!match) {
        return null;
      }
      const [wholePart, fractionPart = ""] = trimmed.split(".");
      const fractionPadded = (fractionPart + "00").slice(0, 2);
      return Number(wholePart) * 100 + Number(fractionPadded);
    }

    function formatMoneyFromPaise(paise) {
      return moneyFormat.format(paise / 100);
    }

    function getEntryPaise(entry) {
      const paise = parseAmountToPaise(String(entry.amount));
      return paise === null ? 0 : paise;
    }

    function loadEntries() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return [];
      }
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (error) {
        return [];
      }
    }

    function saveEntries(entries) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    function render(entries) {
      entriesBody.innerHTML = "";
      let runningBalancePaise = 0;
      let totalIncomePaise = 0;
      let totalExpensePaise = 0;

      if (entries.length === 0) {
        emptyState.style.display = "block";
      } else {
        emptyState.style.display = "none";
      }

      entries.forEach((entry, index) => {
        const amountPaise = getEntryPaise(entry);
        if (entry.type === "income") {
          runningBalancePaise += amountPaise;
          totalIncomePaise += amountPaise;
        } else {
          runningBalancePaise -= amountPaise;
          totalExpensePaise += amountPaise;
        }

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${formatDateForDisplay(entry.date)}</td>
          <td>${entry.description}</td>
          <td class="amount-income">${entry.type === "income" ? formatMoneyFromPaise(amountPaise) : ""}</td>
          <td class="amount-expense">${entry.type === "expense" ? formatMoneyFromPaise(amountPaise) : ""}</td>
          <td class="${runningBalancePaise >= 0 ? "balance-positive" : "balance-negative"}">
            ${formatMoneyFromPaise(runningBalancePaise)}
          </td>
          <td>
            <button type="button" data-action="edit" data-index="${index}">Edit</button>
            <button type="button" data-action="delete" data-index="${index}">Delete</button>
          </td>
        `;
        entriesBody.appendChild(row);
      });

      totalIncomeEl.textContent = formatMoneyFromPaise(totalIncomePaise);
      totalExpenseEl.textContent = formatMoneyFromPaise(totalExpensePaise);
      currentBalanceEl.textContent = formatMoneyFromPaise(runningBalancePaise);
    }

    function setToday() {
      const today = new Date().toISOString().split("T")[0];
      dateInput.value = today;
    }

    function resetForm() {
      editIndex = null;
      submitButton.textContent = getUiText("saveEntry");
      form.reset();
      setToday();
      typeInput.value = "income";
    }

    function highlightField(fieldElement) {
      if (!fieldElement) {
        return;
      }
      fieldElement.classList.remove("voice-highlight");
      void fieldElement.offsetWidth;
      fieldElement.classList.add("voice-highlight");
      setTimeout(() => {
        fieldElement.classList.remove("voice-highlight");
      }, 1500);
    }

    function normalizeSpokenDate(spokenDate) {
      if (!spokenDate) {
        return "";
      }

      const cleaned = spokenDate
        .toLowerCase()
        .replace(/(st|nd|rd|th)\b/g, "")
        .replace(/,/g, " ")
        .replace(/\s+/g, " ")
        .trim();

      const directDate = new Date(cleaned);
      if (!Number.isNaN(directDate.getTime())) {
        const y = directDate.getFullYear();
        const m = String(directDate.getMonth() + 1).padStart(2, "0");
        const d = String(directDate.getDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
      }

      const parts = cleaned.match(/\d+/g);
      if (!parts || parts.length < 3) {
        return "";
      }

      let day = Number(parts[0]);
      let month = Number(parts[1]);
      let year = Number(parts[2]);

      if (parts[0].length === 4) {
        year = Number(parts[0]);
        month = Number(parts[1]);
        day = Number(parts[2]);
      }

      if (year < 100) {
        year += 2000;
      }

      if (month < 1 || month > 12 || day < 1 || day > 31) {
        return "";
      }

      const parsedDate = new Date(year, month - 1, day);
      if (
        parsedDate.getFullYear() !== year ||
        parsedDate.getMonth() !== month - 1 ||
        parsedDate.getDate() !== day
      ) {
        return "";
      }

      return `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
    }

    function parseSpokenAmount(spokenAmount) {
      if (!spokenAmount) {
        return "";
      }

      const normalized = spokenAmount
        .toLowerCase()
        .replace(/,/g, "")
        .replace(/\bpoint\b/g, ".")
        .replace(/[^\d.]/g, "")
        .replace(/\.(?=.*\.)/g, "");

      if (!normalized) {
        return "";
      }

      const amountNumber = Number(normalized);
      if (Number.isNaN(amountNumber)) {
        return "";
      }

      const amountFixed = amountNumber.toFixed(2);
      return amountFixed.replace(/\.00$/, "");
    }

    function extractCommandAndValue(spokenText) {
      const lowered = spokenText.toLowerCase();
      const keywords = languageConfig[currentLanguage].keywords;

      const findKeywordStart = (keywordList) => {
        for (const word of keywordList) {
          if (lowered.startsWith(word.toLowerCase())) {
            return word;
          }
        }
        return "";
      };

      const keywordOrder = [
        { command: "date", words: keywords.date },
        { command: "description", words: keywords.description },
        { command: "amount", words: keywords.amount },
        { command: "income", words: keywords.income },
        { command: "expense", words: keywords.expense },
      ];

      for (const item of keywordOrder) {
        const matchedKeyword = findKeywordStart(item.words);
        if (!matchedKeyword) {
          continue;
        }

        const escapedKeyword = matchedKeyword.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        const value = spokenText.replace(new RegExp(`^${escapedKeyword}\\b[:\- ]*`, "i"), "").trim();
        return { command: item.command, value };
      }

      return null;
    }

    function applyVoiceCommand(transcript) {
      const spokenText = transcript.trim();
      if (!spokenText) {
        return;
      }

      const commandInfo = extractCommandAndValue(spokenText);
      if (!commandInfo) {
        return;
      }

      const { command, value } = commandInfo;

      if (command === "income") {
        typeInput.value = "income";
        highlightField(typeInput);
        return;
      }

      if (command === "expense") {
        typeInput.value = "expense";
        highlightField(typeInput);
        return;
      }

      if (command === "date") {
        const normalizedDate = normalizeSpokenDate(value);
        if (normalizedDate) {
          dateInput.value = normalizedDate;
          highlightField(dateInput);
        }
        return;
      }

      if (command === "description") {
        if (value) {
          descInput.value = value;
          highlightField(descInput);
        }
        return;
      }

      if (command === "amount") {
        const parsedAmount = parseSpokenAmount(value);
        if (parsedAmount) {
          amountInput.value = parsedAmount;
          highlightField(amountInput);
        }
      }
    }

    function setupVoiceInput() {
      if (!SpeechRecognition) {
        voiceInputButton.addEventListener("click", () => {
          alert(getUiText("unsupportedSpeech"));
        });
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = languageConfig[currentLanguage].speechLang;
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.addEventListener("result", (event) => {
        const result = event.results[0];
        if (!result || !result[0] || !result[0].transcript) {
          return;
        }
        applyVoiceCommand(result[0].transcript);
      });

      recognition.addEventListener("error", () => {
        // Ignore speech errors safely without interrupting manual entry workflow.
      });

      voiceInputButton.addEventListener("click", () => {
        try {
          recognition.lang = languageConfig[currentLanguage].speechLang;
          recognition.start();
        } catch (error) {
          // Ignore repeated start calls safely.
        }
      });
    }

    form.addEventListener("submit", (event) => {
      event.preventDefault();

      const date = dateInput.value.trim();
      const description = descInput.value.trim();
      const amountValue = amountInput.value;
      const type = typeInput.value;

      if (!date || !description || !amountValue) {
        alert(getUiText("missingFields"));
        return;
      }

      const amountPaise = parseAmountToPaise(amountValue);
      if (amountPaise === null || amountPaise <= 0) {
        alert(getUiText("invalidAmount"));
        return;
      }

      const entries = loadEntries();
      const entryPayload = {
        date,
        description,
        amount: amountValue,
        type,
      };

      if (editIndex === null) {
        entries.push(entryPayload);
      } else {
        entries[editIndex] = entryPayload;
      }
      saveEntries(entries);
      render(entries);

      resetForm();
      descInput.focus();
    });

    entriesBody.addEventListener("click", (event) => {
      const button = event.target.closest("button");
      if (!button) {
        return;
      }

      const action = button.dataset.action;
      const index = Number(button.dataset.index);
      if (Number.isNaN(index)) {
        return;
      }

      const entries = loadEntries();
      if (!entries[index]) {
        return;
      }

      if (action === "edit") {
        const entry = entries[index];
        editIndex = index;
        dateInput.value = entry.date;
        descInput.value = entry.description;
        amountInput.value = entry.amount;
        typeInput.value = entry.type;
        submitButton.textContent = getUiText("saveEntry");
        descInput.focus();
        return;
      }

      if (action === "delete") {
        entries.splice(index, 1);
        if (editIndex === index) {
          resetForm();
        } else if (editIndex !== null && index < editIndex) {
          editIndex -= 1;
        }
        saveEntries(entries);
        render(entries);
      }
    });

    languageSelect.addEventListener("change", () => {
      setLanguage(languageSelect.value);
    });

    setToday();
    setupVoiceInput();
    setLanguage("en");
    const initialEntries = loadEntries();
    render(initialEntries);
  </script>
</body>
</html>
